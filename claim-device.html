<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claim Device - AVONIC</title>
  <link rel="stylesheet" href="claim-device.css">
</head>
<body>
  <div class="claim-container">
    <div class="claim-header">
      <h1>ðŸ”— Claim Your Device</h1>
      <p>Enter your ESP32 device ID to link it to your account</p>
    </div>

    <div id="alertBox" class="alert"></div>

    <form id="claimForm">
      <div class="form-group">
        <label for="espID">ESP Device ID</label>
        <input 
          type="text" 
          id="espID" 
          name="espID" 
          placeholder="e.g., AVONIC-A1B2C3D4E5F6"
          maxlength="22"
          required
          autocomplete="off"
        >
      </div>

      <button type="submit" class="btn-claim" id="claimBtn">
        ðŸŽ¯ Claim This Device
      </button>

      <button type="button" class="btn-skip" onclick="skipToDashboard()">
        Skip for now - I'll claim later
      </button>
    </form>

    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner"></div>
      <p style="margin-top: 10px; color: #7f8c8d;">Claiming device...</p>
    </div>

    <div class="device-info" id="deviceInfo">
      <h3>âœ… Device Claimed Successfully!</h3>
      <p><strong>Device ID:</strong> <span id="claimedESPID"></span></p>
      <p><strong>Nickname:</strong> <span id="claimedNickname"></span></p>
      <p style="margin-top: 15px; color: #2e7d32;">
        Redirecting to dashboard...
      </p>
    </div>

    <div class="help-text">
      <strong>Where to find your ESP-ID:</strong>
      â€¢ Check the LCD screen on your device<br>
      â€¢ Look for "ESP-ID: AVONIC-XXXXXXXXXXXX"<br>
      â€¢ Or connect to your device's WiFi AP and visit the setup page
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;

    // Get token from localStorage or URL
    const token = localStorage.getItem('token') || new URLSearchParams(window.location.search).get('token');

    if (!token) {
      alert('You must be logged in to claim devices');
      window.location.href = '/login.html';
    }

    // Auto-format ESP-ID input
    document.getElementById('espID').addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
    });

    // Handle form submission
    document.getElementById('claimForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const espID = document.getElementById('espID').value.trim();
      const alertBox = document.getElementById('alertBox');
      const claimBtn = document.getElementById('claimBtn');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const deviceInfo = document.getElementById('deviceInfo');

      // Validate ESP-ID format
      if (!espID.startsWith('AVONIC-') || espID.length < 17) {
        showAlert('Please enter a valid ESP-ID (format: AVONIC-XXXXXXXXXXXX)', 'error');
        return;
      }

      // Hide previous alerts
      alertBox.style.display = 'none';
      deviceInfo.style.display = 'none';

      // Show loading
      claimBtn.disabled = true;
      loadingSpinner.style.display = 'block';

      try {
        const response = await fetch(`${API_BASE}/api/devices/claim`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ espID })
        });

        const data = await response.json();

        loadingSpinner.style.display = 'none';

        if (response.ok) {
          // Show success
          document.getElementById('claimedESPID').textContent = data.device.espID;
          document.getElementById('claimedNickname').textContent = data.device.nickname;
          deviceInfo.style.display = 'block';

          // Redirect after 2 seconds
          setTimeout(() => {
            window.location.href = '/dashboard.html';
          }, 2000);

        } else {
          showAlert(data.error || 'Failed to claim device', 'error');
          claimBtn.disabled = false;
        }

      } catch (error) {
        console.error('Claim error:', error);
        loadingSpinner.style.display = 'none';
        showAlert('Network error. Please check your connection.', 'error');
        claimBtn.disabled = false;
      }
    });

    function showAlert(message, type) {
      const alertBox = document.getElementById('alertBox');
      alertBox.textContent = message;
      alertBox.className = `alert ${type}`;
      alertBox.style.display = 'block';
    }

    function skipToDashboard() {
      if (confirm('You can claim devices later from the dashboard. Continue?')) {
        window.location.href = '/dashboard.html';
      }
    }
  </script>
</body>
</html>