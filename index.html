<!DOCTYPE html>
<html>
<head>
    <title>AVONIC Vermicomposting System</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="chart.js"></script> <!-- Chart.js hosted locally -->
</head>
<body>
    <div class="container">
        <header>
            <h1>AVONIC Vermicomposting System</h1>
            <p class="subtitle">Automated African Nightcrawler Environment Monitor</p>
            <div class="sensor-notice">MQ-135 sensors stabilizing (24-48h required for accurate readings)</div>
        </header>
        
        <div class="system-status">
            <div class="update-time">Last Update: <span id="lastUpdate">--</span></div>
        </div>
        
        <div class="bins-container">
            <!-- BIN 1 -->
            <div class="bin-card">
                <div class="bin-header">
                    <h2>BIN 1</h2>
                    <div id="status1" class="status offline">OFFLINE</div>
                </div>
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <div class="sensor-icon">Temp</div>
                        <div class="sensor-value"><span id="temp1">--</span><span class="unit">C</span></div>
                        <div class="sensor-label">Temperature</div>
                        <div class="optimal-range">Optimal: 20-30C</div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-icon">Hum</div>
                        <div class="sensor-value"><span id="hum1">--</span><span class="unit">%</span></div>
                        <div class="sensor-label">Humidity</div>
                        <div class="optimal-range">Optimal: 45-85%</div>
                    </div>
                    <div class="sensor-item soil-item">
                        <div class="sensor-icon">Soil</div>
                        <div class="sensor-value"><span id="soil1">--</span><span class="unit">%</span></div>
                        <div class="sensor-label">Soil Moisture</div>
                        <div class="optimal-range">Optimal: ~60%</div>
                        <div class="soil-bar-container"><div class="soil-bar" id="soilBar1"></div></div>
                    </div>
                    <div class="sensor-item gas-item">
                        <div class="sensor-icon">Gas</div>
                        <div class="sensor-value"><span id="gas1">--</span><span class="unit">ppm</span></div>
                        <div class="sensor-label">Ammonia Level</div>
                        <div class="optimal-range">Alert: >400ppm</div>
                        <div class="gas-bar-container"><div class="gas-bar" id="gasBar1"></div></div>
                    </div>
                    <!-- Fan + Pump Controls Bin 1 -->
                    <div class="sensor-item fan-item">
                        <div class="sensor-icon">Fan</div>
                        <div class="sensor-value"><span id="fan1Status">OFF</span></div>
                        <div class="sensor-label">Exhaust Fan</div>
                        <div class="fan-controls">
                            <button id="fan1ModeBtn" class="mode-btn" onclick="toggleFan1Mode()">AUTO</button>
                            <button id="fan1ToggleBtn" class="toggle-btn" onclick="toggleFan1()" disabled>TOGGLE</button>
                        </div>
                        <div class="fan-thresholds">Triggers: &gt;28C or &gt;80% humidity</div>
                    </div>
                    <div class="sensor-item pump-item">
                        <div class="sensor-icon">Pump</div>
                        <div class="sensor-value"><span id="pump1Status">OFF</span></div>
                        <div class="sensor-label">Water Pump</div>
                        <div class="pump-controls">
                            <button id="pump1ModeBtn" class="mode-btn" onclick="togglePump1Mode()">AUTO</button>
                            <button id="pump1ToggleBtn" class="toggle-btn" onclick="togglePump1()" disabled>TOGGLE</button>
                        </div>
                        <div class="pump-thresholds">Triggers: &gt;30C or &lt;30% humidity</div>
                    </div>
                </div>
            </div>

            <!-- BIN 2 (unchanged) -->
            <div class="bin-card">
                <div class="bin-header">
                    <h2>BIN 2</h2>
                    <div id="status2" class="status offline">OFFLINE</div>
                </div>
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <div class="sensor-icon">Temp</div>
                        <div class="sensor-value"><span id="temp2">--</span><span class="unit">C</span></div>
                        <div class="sensor-label">Temperature</div>
                        <div class="optimal-range">Optimal: 20-30C</div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-icon">Hum</div>
                        <div class="sensor-value"><span id="hum2">--</span><span class="unit">%</span></div>
                        <div class="sensor-label">Humidity</div>
                        <div class="optimal-range">Optimal: 45-85%</div>
                    </div>
                    <div class="sensor-item soil-item">
                        <div class="sensor-icon">Soil</div>
                        <div class="sensor-value"><span id="soil2">--</span><span class="unit">%</span></div>
                        <div class="sensor-label">Soil Moisture</div>
                        <div class="optimal-range">Optimal: ~60%</div>
                        <div class="soil-bar-container"><div class="soil-bar" id="soilBar2"></div></div>
                    </div>
                    <div class="sensor-item gas-item">
                        <div class="sensor-icon">Gas</div>
                        <div class="sensor-value"><span id="gas2">--</span><span class="unit">ppm</span></div>
                        <div class="sensor-label">Ammonia Level</div>
                        <div class="optimal-range">Alert: >400ppm</div>
                        <div class="gas-bar-container"><div class="gas-bar" id="gasBar2"></div></div>
                    </div>
                    <!-- Controls Bin 2 -->
                    <div class="sensor-item fan-item">
                        <div class="sensor-icon">Fan</div>
                        <div class="sensor-value"><span id="fan2Status">OFF</span></div>
                        <div class="sensor-label">Exhaust Fan</div>
                        <div class="fan-controls">
                            <button id="fan2ModeBtn" class="mode-btn" onclick="toggleFan2Mode()">AUTO</button>
                            <button id="fan2ToggleBtn" class="toggle-btn" onclick="toggleFan2()" disabled>TOGGLE</button>
                        </div>
                        <div class="fan-thresholds">Triggers: &gt;28C or &gt;80% humidity</div>
                    </div>
                    <div class="sensor-item pump-item">
                        <div class="sensor-icon">Pump</div>
                        <div class="sensor-value"><span id="pump2Status">OFF</span></div>
                        <div class="sensor-label">Water Pump</div>
                        <div class="pump-controls">
                            <button id="pump2ModeBtn" class="mode-btn" onclick="togglePump2Mode()">AUTO</button>
                            <button id="pump2ToggleBtn" class="toggle-btn" onclick="togglePump2()" disabled>TOGGLE</button>
                        </div>
                        <div class="pump-thresholds">Triggers: &gt;30C or &lt;30% humidity</div>
                    </div>

                    <div class="sensor-item">
                        <div class="sensor-icon">DS18</div>
                        <div class="sensor-value"><span id="ds18b20Temp">--</span><span class="unit">°C</span></div>
                        <div class="sensor-label">Precision Temp</div>
                        <div class="optimal-range">High Accuracy</div>
                    </div>
                    <div class="sensor-item">
                        <div class="sensor-icon">US</div>
                        <div class="sensor-value"><span id="ultrasonic">--</span><span class="unit">cm</span></div>
                        <div class="sensor-label">Ultrasonic Distance</div>
                        <div class="optimal-range">Range: 2–400cm</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CHART CARD -->
        <div class="bin-card">
            <div class="bin-header"><h2>Sensor Trends</h2></div>
            <canvas id="sensorChart" style="max-height:400px;"></canvas>
        </div>

        <!-- ALERTS -->
        <div id="alerts" class="alerts-section" style="display:none;"></div>
        
        <footer>
            <p>AVONIC - Automated Vermicomposting System | Calaca, Batangas</p>
            RTC Time: <span id="rtcTime">--</span>
        </footer>
    </div>

<script>
/* ---------- MQTT Configuration ---------- */
const MQTT_BROKER = "3fbd52903d154a689cae6941ba13bfcf.s1.eu.hivemq.cloud";
const MQTT_PORT = 8884; // WebSocket Secure port
const MQTT_USER = "avonic-system";
const MQTT_PASS = "Avonic123";
const MQTT_TOPIC = "avonic/sensors";

let client;
let sensorChart = null;

/* ---------- MQTT Connection ---------- */
function connectMQTT() {
  const clientId = "web_" + Math.random().toString(16).substr(2, 8);
  client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, "/mqtt", clientId);
  
  client.onConnectionLost = function(responseObject) {
    console.log("MQTT Connection Lost:", responseObject.errorMessage);
    document.getElementById('lastUpdate').textContent = "DISCONNECTED";
    setTimeout(connectMQTT, 5000); // Reconnect after 5s
  };
  
  client.onMessageArrived = function(message) {
    console.log("Message received:", message.payloadString);
    try {
      const data = JSON.parse(message.payloadString);
      updateDisplay(data);
      updateChart(data);
    } catch(e) {
      console.error("JSON parse error:", e);
    }
  };
  
  const connectOptions = {
    useSSL: true,
    userName: MQTT_USER,
    password: MQTT_PASS,
    onSuccess: function() {
      console.log("MQTT Connected!");
      document.getElementById('lastUpdate').textContent = "CONNECTED";
      client.subscribe(MQTT_TOPIC);
      client.subscribe("avonic/#"); // Subscribe to all AVONIC topics
    },
    onFailure: function(err) {
      console.error("MQTT Connection Failed:", err);
      document.getElementById('lastUpdate').textContent = "CONNECTION FAILED";
      setTimeout(connectMQTT, 5000);
    }
  };
  
  client.connect(connectOptions);
}

/* ---------- Helper Functions ---------- */
function getSoilColor(percent) {
  if (percent < 30) return '#e74c3c';
  if (percent < 50) return '#f39c12';
  if (percent < 70) return '#27ae60';
  if (percent < 85) return '#3498db';
  return '#9b59b6';
}

function getGasColor(ppm) {
  if (ppm < 200) return '#27ae60';
  if (ppm < 400) return '#f39c12';
  if (ppm < 600) return '#e67e22';
  return '#e74c3c';
}

/* ---------- Update Display ---------- */
function updateDisplay(data) {
  // Handle nested structure from MQTT
  const bin1 = data.bin1 || {};
  const bin2 = data.bin2 || {};
  
  document.getElementById('temp1').textContent = bin1.temp !== undefined ? bin1.temp.toFixed(1) : "--";
  document.getElementById('hum1').textContent = bin1.humidity !== undefined ? bin1.humidity.toFixed(1) : "--";
  document.getElementById('soil1').textContent = bin1.soil !== undefined ? bin1.soil : "--";
  document.getElementById('gas1').textContent = bin1.gas !== undefined ? bin1.gas : "--";
  
  document.getElementById('temp2').textContent = bin2.temp !== undefined ? bin2.temp.toFixed(1) : "--";
  document.getElementById('hum2').textContent = bin2.humidity !== undefined ? bin2.humidity.toFixed(1) : "--";
  document.getElementById('soil2').textContent = bin2.soil !== undefined ? bin2.soil : "--";
  document.getElementById('gas2').textContent = bin2.gas !== undefined ? bin2.gas : "--";
  
  document.getElementById('ds18b20Temp').textContent = bin1.ds18b20 !== undefined ? bin1.ds18b20.toFixed(2) : "--";
  document.getElementById('ultrasonic').textContent = bin1.ultrasonic !== undefined ? bin1.ultrasonic : "--";
  
  // Update timestamp
  const now = new Date().toLocaleTimeString();
  document.getElementById('lastUpdate').textContent = now;
  
  // Update status indicators
  const sensor1_ok = data.temp1 !== undefined && !isNaN(data.temp1);
  const sensor2_ok = data.temp2 !== undefined && !isNaN(data.temp2);
  
  document.getElementById('status1').className = 'status ' + (sensor1_ok ? 'online' : 'offline');
  document.getElementById('status1').textContent = sensor1_ok ? 'ONLINE' : 'OFFLINE';
  document.getElementById('status2').className = 'status ' + (sensor2_ok ? 'online' : 'offline');
  document.getElementById('status2').textContent = sensor2_ok ? 'ONLINE' : 'OFFLINE';
  
  // Soil bars
  let s1 = data.soil1 !== undefined ? data.soil1 : 0;
  let s2 = data.soil2 !== undefined ? data.soil2 : 0;
  document.getElementById('soilBar1').style.width = s1 + '%';
  document.getElementById('soilBar2').style.width = s2 + '%';
  document.getElementById('soilBar1').style.backgroundColor = getSoilColor(s1);
  document.getElementById('soilBar2').style.backgroundColor = getSoilColor(s2);
  
  // Gas bars
  let g1 = data.gas1 !== undefined ? data.gas1 : 0;
  let g2 = data.gas2 !== undefined ? data.gas2 : 0;
  document.getElementById('gasBar1').style.width = Math.min(g1 / 10, 100) + '%';
  document.getElementById('gasBar2').style.width = Math.min(g2 / 10, 100) + '%';
  document.getElementById('gasBar1').style.backgroundColor = getGasColor(g1);
  document.getElementById('gasBar2').style.backgroundColor = getGasColor(g2);
}

/* ---------- Chart Functions ---------- */
function initChart() {
  const ctx = document.getElementById('sensorChart').getContext('2d');
  sensorChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Temp1 (°C)', data: [], borderColor: 'red', fill: false },
        { label: 'Hum1 (%)', data: [], borderColor: 'blue', fill: false },
        { label: 'Temp2 (°C)', data: [], borderColor: 'orange', fill: false },
        { label: 'Hum2 (%)', data: [], borderColor: 'cyan', fill: false }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: 'Time' } },
        y: { beginAtZero: true }
      }
    }
  });
}

function updateChart(data) {
  if (!sensorChart) return;
  
  const now = new Date().toLocaleTimeString();
  sensorChart.data.labels.push(now);
  sensorChart.data.datasets[0].data.push(data.temp1);
  sensorChart.data.datasets[1].data.push(data.hum1);
  sensorChart.data.datasets[2].data.push(data.temp2);
  sensorChart.data.datasets[3].data.push(data.hum2);
  
  // Keep only last 30 data points
  if (sensorChart.data.labels.length > 30) {
    sensorChart.data.labels.shift();
    sensorChart.data.datasets.forEach(ds => ds.data.shift());
  }
  
  sensorChart.update();
}

/* ---------- Control Functions (Cloud-Enabled) ---------- */
function toggleFan1Mode() {
  if (client && client.isConnected()) {
    const message = new Paho.MQTT.Message("toggle");
    message.destinationName = "avonic/fan1/mode";
    client.send(message);
  }
}

function toggleFan1() {
  if (client && client.isConnected()) {
    const message = new Paho.MQTT.Message("toggle");
    message.destinationName = "avonic/fan1/toggle";
    client.send(message);
  }
}

function toggleFan2Mode() {
  if (client && client.isConnected()) {
    const message = new Paho.MQTT.Message("toggle");
    message.destinationName = "avonic/fan2/mode";
    client.send(message);
  }
}

function toggleFan2() {
  if (client && client.isConnected()) {
    const message = new Paho.MQTT.Message("toggle");
    message.destinationName = "avonic/fan2/toggle";
    client.send(message);
  }
}

function togglePump1Mode() {
  if (client && client.isConnected()) {
    const message = new Paho.MQTT.Message("toggle");
    message.destinationName = "avonic/pump1/mode";
    client.send(message);
  }
}

function togglePump1() {
  if (client && client.isConnected()) {
    const message = new Paho.MQTT.Message("toggle");
    message.destinationName = "avonic/pump1/toggle";
    client.send(message);
  }
}

function togglePump2Mode() {
  if (client && client.isConnected()) {
    const message = new Paho.MQTT.Message("toggle");
    message.destinationName = "avonic/pump2/mode";
    client.send(message);
  }
}

function togglePump2() {
  if (client && client.isConnected()) {
    const message = new Paho.MQTT.Message("toggle");
    message.destinationName = "avonic/pump2/toggle";
    client.send(message);
  }
}

/* ---------- Initialize on Page Load ---------- */
window.onload = function() {
  initChart();
  connectMQTT();
};
</script>

</body>
</html>




