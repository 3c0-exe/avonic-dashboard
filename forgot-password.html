<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AVONIC - Reset Password</title>
  <link rel="stylesheet" href="auth.css">
</head>
<body>
  <div class="split-container">
    <!-- LEFT SIDE - Illustration -->
    <div class="illustration-side">
      <div class="illustration-placeholder">
        <!-- STANDBY CODE FOR ILLUSTRATION -->
        <!-- TO ADD YOUR ILLUSTRATION:
             Replace this div with:
             <img src="/path/to/illustration.svg" alt="AVONIC" class="illustration-img">
        -->
        üå± Add your illustration here
      </div>
      <div class="brand-tagline">
        Lost your way?<br>We'll help you get back on track.
      </div>
    </div>

    <!-- RIGHT SIDE - Form -->
    <div class="form-side">
      <div class="form-container">
        <div class="logo-container">
          <img src="img/Avonic Logo.svg" alt="AVONIC Logo">
        </div>
        
        <h1>Reset password</h1>
        <p class="subtitle">We'll send you a code to reset it</p>
        
        <div id="message"></div>
        
        <!-- Step 1: Request Reset via Email -->
        <form id="requestResetForm">
          <div class="form-group">
            <label>Email Address</label>
            <input type="email" name="email" required placeholder="your@email.com" autofocus>
            <small>We'll send a 6-digit reset code to your email</small>
          </div>
          
          <button type="submit" class="btn">Send Reset Code</button>
        </form>
        
        <!-- Step 2: Enter Reset Code (Hidden initially) -->
        <form id="resetCodeForm" style="display: none;">
          <div class="form-group">
            <label>Reset Code</label>
            <input type="text" name="resetCode" required placeholder="000000" 
                   pattern="[0-9]{6}" maxlength="6">
            <small>Check your email for the 6-digit code (expires in 15 minutes)</small>
          </div>
          
          <div class="form-group">
            <label>New Password</label>
            <input type="password" name="newPassword" required minlength="6" placeholder="Enter new password">
          </div>
          
          <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" name="confirmPassword" required minlength="6" placeholder="Confirm new password">
          </div>
          
          <button type="submit" class="btn">Reset Password</button>
          <button type="button" class="btn btn-secondary" onclick="showRequestForm()">Back</button>
        </form>
        
        <div class="divider"></div>
        
        <div class="register-prompt">
          Remember your password? 
          <a href="login.html" class="link-bold">Login here</a>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // === ENVIRONMENT DETECTION ===
    const isESP32 = window.location.hostname.match(/192\.168\.|\.local/) || 
                    window.location.port === '80' ||
                    window.location.protocol === 'http:';
    
    const API_BASE = isESP32 ? '' : 'https://avonic-main-hub-production.up.railway.app';
    
    console.log('üåç Environment:', isESP32 ? 'ESP32 (Offline)' : 'GitHub Pages (Online)');
    console.log('üîó API Base:', API_BASE || 'Local ESP32');
    
    let resetToken = null;
    let userEmail = null;
    
    // === STEP 1: REQUEST PASSWORD RESET (Email) ===
    document.getElementById('requestResetForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('.btn');
      const msg = document.getElementById('message');
      
      btn.disabled = true;
      btn.textContent = 'Sending email...';
      msg.innerHTML = '';
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      userEmail = data.email;
      
      console.log('üì§ Requesting password reset for:', userEmail);
      
      try {
        let res, json;
        
        if (isESP32) {
          // === ESP32 LOCAL RESET REQUEST ===
          res = await fetch('/password-reset-request', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({ email: userEmail })
          });
          json = await res.json();
          
        } else {
          // === ONLINE RESET REQUEST (via Railway) ===
          res = await fetch(`${API_BASE}/api/password/reset-request`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: userEmail })
          });
          json = await res.json();
        }
        
        console.log('üì¶ Response:', json);
        
        if (res.ok && json.success) {
          msg.innerHTML = `
            <div class="success">
              ‚úÖ <strong>Reset Code Sent!</strong><br><br>
              üìß Check your email (<strong>${userEmail}</strong>) for a 6-digit code.<br><br>
              <small>‚è±Ô∏è Code expires in 15 minutes</small>
            </div>
          `;
          
          // Show reset code form
          setTimeout(() => {
            document.getElementById('requestResetForm').style.display = 'none';
            document.getElementById('resetCodeForm').style.display = 'block';
          }, 2000);
          
        } else {
          msg.innerHTML = '<div class="error">‚ùå ' + (json.error || 'Failed to send reset email') + '</div>';
          btn.disabled = false;
          btn.textContent = 'Send Reset Code';
        }
      } catch (err) {
        console.error('‚ùå Reset request error:', err);
        msg.innerHTML = '<div class="error">‚ùå Connection error: ' + err.message + '</div>';
        btn.disabled = false;
        btn.textContent = 'Send Reset Code';
      }
    });
    
    // === STEP 2: SUBMIT RESET CODE & NEW PASSWORD ===
    document.getElementById('resetCodeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('.btn');
      const msg = document.getElementById('message');
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      // Validate password match
      if (data.newPassword !== data.confirmPassword) {
        msg.innerHTML = '<div class="error">‚ùå Passwords do not match!</div>';
        return;
      }
      
      if (data.newPassword.length < 6) {
        msg.innerHTML = '<div class="error">‚ùå Password must be at least 6 characters</div>';
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Resetting password...';
      msg.innerHTML = '';
      
      console.log('üì§ Submitting reset code:', data.resetCode);
      
      try {
        let res, json;
        
        if (isESP32) {
          // === ESP32 LOCAL RESET ===
          res = await fetch('/password-reset', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
              token: data.resetCode,
              new_password: data.newPassword
            })
          });
          json = await res.json();
          
        } else {
          // === ONLINE RESET (via Railway) ===
          res = await fetch(`${API_BASE}/api/password/reset`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              token: data.resetCode,
              new_password: data.newPassword
            })
          });
          json = await res.json();
        }
        
        console.log('üì¶ Response:', json);
        
        if (res.ok && json.success) {
          msg.innerHTML = `
            <div class="success">
              ‚úÖ <strong>Password Reset Successful!</strong><br><br>
              You can now login with your new password.<br>
              Redirecting to login page...
            </div>
          `;
          
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 3000);
          
        } else {
          msg.innerHTML = '<div class="error">‚ùå ' + (json.error || 'Invalid or expired reset code') + '</div>';
          btn.disabled = false;
          btn.textContent = 'Reset Password';
        }
      } catch (err) {
        console.error('‚ùå Password reset error:', err);
        msg.innerHTML = '<div class="error">‚ùå Connection error: ' + err.message + '</div>';
        btn.disabled = false;
        btn.textContent = 'Reset Password';
      }
    });
    
    // === HELPER: GO BACK TO REQUEST FORM ===
    function showRequestForm() {
      document.getElementById('resetCodeForm').style.display = 'none';
      document.getElementById('requestResetForm').style.display = 'block';
      document.getElementById('message').innerHTML = '';
      document.querySelector('#requestResetForm .btn').disabled = false;
      document.querySelector('#requestResetForm .btn').textContent = 'Send Reset Code';
    }
    
    // Auto-format reset code as numbers only
    document.querySelector('input[name="resetCode"]').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
    
    console.log('‚úÖ Forgot password page loaded');
  </script>
</body>
</html>
