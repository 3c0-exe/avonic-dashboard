<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AVONIC Registration</title>
  <link rel="stylesheet" href="auth.css">
</head>
<body>
  <div class="split-container">
    <!-- LEFT SIDE - Illustration -->
    <div class="illustration-side">
      <div class="illustration-placeholder">
        üå± Add your illustration here
      </div>
      <div class="brand-tagline">
        Smart vermicomposting automation.<br>Cultivate smarter, not harder.
      </div>
    </div>

    <!-- RIGHT SIDE - Form -->
    <div class="form-side">
      <div class="form-container">
        <div class="logo-container">
          <img src="img/Avonic Logo.svg" alt="AVONIC Logo">
        </div>
        
        <h1>Get started</h1>
        <p class="subtitle">Create your account</p>
        
        <div id="message"></div>
        
        <form id="registerForm">
          <div class="form-group">
            <label>Username</label>
            <input type="text" name="username" required minlength="3" maxlength="20" 
                   placeholder="Choose a username" pattern="[a-zA-Z0-9_]+">
            <small>3-20 characters, alphanumeric only</small>
          </div>
          
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" required placeholder="your@email.com">
          </div>
          
          <div class="form-group">
            <label>Password</label>
            <input type="password" name="password" required minlength="6" placeholder="Min. 6 characters">
          </div>
          
          <button type="submit" class="btn">Register</button>
        </form>
        
        <div class="divider"></div>
        
        <div class="register-prompt">
          Already have an account? 
          <a href="login.html" class="link-bold">Login here</a>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const API_BASE = 'https://avonic-main-hub-production.up.railway.app';
    
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('.btn');
      const msg = document.getElementById('message');
      
      btn.disabled = true;
      btn.textContent = 'Registering...';
      msg.innerHTML = '';
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      console.log('üì§ Registering user:', data.username);
      
      try {
        const res = await fetch(`${API_BASE}/api/register`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            username: data.username,
            email: data.email,
            password: data.password
          })
        });
        
        const json = await res.json();
        console.log('üì¶ Response:', json);
        
        if (res.ok && json.token) {
          msg.innerHTML = `
            <div class="success">
              ‚úÖ <strong>Account Created!</strong><br><br>
              Welcome, ${data.username}! üéâ<br><br>
              Redirecting to claim your device...
            </div>
          `;
          
          // Store token and redirect to claim page
          localStorage.setItem('avonic_token', json.token);
          localStorage.setItem('avonic_user', JSON.stringify(json.user));
          
          setTimeout(() => {
            window.location.href = 'index.html#/claim-device';
          }, 2000);
          
        } else {
          msg.innerHTML = '<div class="error">‚ùå ' + (json.error || 'Registration failed') + '</div>';
          btn.disabled = false;
          btn.textContent = 'Register';
        }
      } catch (err) {
        console.error('‚ùå Registration error:', err);
        msg.innerHTML = '<div class="error">‚ùå Connection error. Please try again.</div>';
        btn.disabled = false;
        btn.textContent = 'Register';
      }
    });
    
    console.log('‚úÖ Registration page loaded');
  </script>
</body>
</html>